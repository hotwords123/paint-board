
'use strict';

var COLORS = [[0,0,0],[0,0,51],[0,0,102],[0,0,153],[0,0,204],[0,0,255],[0,51,0],[0,51,51],[0,51,102],[0,51,153],[0,51,204],[0,51,255],[0,102,0],[0,102,51],[0,102,102],[0,102,153],[0,102,204],[0,102,255],[0,153,0],[0,153,51],[0,153,102],[0,153,153],[0,153,204],[0,153,255],[0,204,0],[0,204,51],[0,204,102],[0,204,153],[0,204,204],[0,204,255],[0,255,0],[0,255,51],[0,255,102],[0,255,153],[0,255,204],[0,255,255],[51,0,0],[51,0,51],[51,0,102],[51,0,153],[51,0,204],[51,0,255],[51,51,0],[51,51,51],[51,51,102],[51,51,153],[51,51,204],[51,51,255],[51,102,0],[51,102,51],[51,102,102],[51,102,153],[51,102,204],[51,102,255],[51,153,0],[51,153,51],[51,153,102],[51,153,153],[51,153,204],[51,153,255],[51,204,0],[51,204,51],[51,204,102],[51,204,153],[51,204,204],[51,204,255],[51,255,0],[51,255,51],[51,255,102],[51,255,153],[51,255,204],[51,255,255],[102,0,0],[102,0,51],[102,0,102],[102,0,153],[102,0,204],[102,0,255],[102,51,0],[102,51,51],[102,51,102],[102,51,153],[102,51,204],[102,51,255],[102,102,0],[102,102,51],[102,102,102],[102,102,153],[102,102,204],[102,102,255],[102,153,0],[102,153,51],[102,153,102],[102,153,153],[102,153,204],[102,153,255],[102,204,0],[102,204,51],[102,204,102],[102,204,153],[102,204,204],[102,204,255],[102,255,0],[102,255,51],[102,255,102],[102,255,153],[102,255,204],[102,255,255],[153,0,0],[153,0,51],[153,0,102],[153,0,153],[153,0,204],[153,0,255],[153,51,0],[153,51,51],[153,51,102],[153,51,153],[153,51,204],[153,51,255],[153,102,0],[153,102,51],[153,102,102],[153,102,153],[153,102,204],[153,102,255],[153,153,0],[153,153,51],[153,153,102],[153,153,153],[153,153,204],[153,153,255],[153,204,0],[153,204,51],[153,204,102],[153,204,153],[153,204,204],[153,204,255],[153,255,0],[153,255,51],[153,255,102],[153,255,153],[153,255,204],[153,255,255],[204,0,0],[204,0,51],[204,0,102],[204,0,153],[204,0,204],[204,0,255],[204,51,0],[204,51,51],[204,51,102],[204,51,153],[204,51,204],[204,51,255],[204,102,0],[204,102,51],[204,102,102],[204,102,153],[204,102,204],[204,102,255],[204,153,0],[204,153,51],[204,153,102],[204,153,153],[204,153,204],[204,153,255],[204,204,0],[204,204,51],[204,204,102],[204,204,153],[204,204,204],[204,204,255],[204,255,0],[204,255,51],[204,255,102],[204,255,153],[204,255,204],[204,255,255],[255,0,0],[255,0,51],[255,0,102],[255,0,153],[255,0,204],[255,0,255],[255,51,0],[255,51,51],[255,51,102],[255,51,153],[255,51,204],[255,51,255],[255,102,0],[255,102,51],[255,102,102],[255,102,153],[255,102,204],[255,102,255],[255,153,0],[255,153,51],[255,153,102],[255,153,153],[255,153,204],[255,153,255],[255,204,0],[255,204,51],[255,204,102],[255,204,153],[255,204,204],[255,204,255],[255,255,0],[255,255,51],[255,255,102],[255,255,153],[255,255,204],[255,255,255]];

var $input = $('<input type="file">');

function findColor(r, g, b) {
	var mindis = Infinity, res = -1;
	for (var i = 0; i < COLORS.length; ++i) {
		var dis = Math.pow(r - COLORS[i][0], 2) + Math.pow(g - COLORS[i][1], 2) + Math.pow(b - COLORS[i][2], 2);
		if (dis < mindis) {
			mindis = dis;
			res = i;
		}
	}
	return res;
}

$input.on('input', function() {
	if (!this.files.length) return;
	var file = this.files[0];
	var reader = new FileReader();
	reader.onload = function() {
		var img = document.createElement('img');
		img.src = reader.result;
		img.onload = function() {
			var width = img.width;
			var height = img.height;
			var canvas = document.createElement('canvas');
			canvas.width = width;
			canvas.height = height;
			var ctx = canvas.getContext('2d');
			ctx.drawImage(img, 0, 0);
			var res = ctx.getImageData(0, 0, width, height);
			var pos = 0;
			var str = '';
			var OFFSETX = parseInt(prompt("offset x"));
			var OFFSETY = parseInt(prompt("offset y"));
			for (var y = 0; y < height; ++y) {
				for (var x = 0; x < width; ++x) {
					var r = res.data[pos + 0],
						g = res.data[pos + 1],
						b = res.data[pos + 2];
					pos += 4;
					str += `${OFFSETX+x},${OFFSETY+y}=${findColor(r,g,b)};`;
				}
			}
			localStorage.setItem('dest', str);
			console.log('ok');
		};
	};
	reader.readAsDataURL(file);
});

$input.click();

